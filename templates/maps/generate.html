{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Generate Map - Shadowrun Campaign Manager{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2>Generate Map</h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5><i class="bi bi-magic"></i> Procedural Map Generation</h5>
                        <p class="mb-0">
                            Create a new map automatically using procedural generation.
                            You can customize algorithm parameters to fine-tune the generation.
                            Optionally provide a seed for reproducible results.
                        </p>
                    </div>

                    <!-- Preset Selector -->
                    {% if user_presets or public_presets %}
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h5><i class="bi bi-bookmark-star"></i> Load from Preset</h5>
                            <p class="small text-muted mb-2">Quickly fill in the form with a saved configuration</p>
                            <div class="row align-items-end">
                                <div class="col-md-8">
                                    <select id="presetSelector" class="form-control">
                                        <option value="">-- Select a preset --</option>
                                        {% if user_presets %}
                                            <optgroup label="My Presets">
                                                {% for preset in user_presets %}
                                                    <option value="{{ preset.pk }}">{{ preset.name }}</option>
                                                {% endfor %}
                                            </optgroup>
                                        {% endif %}
                                        {% if public_presets %}
                                            <optgroup label="Public Presets">
                                                {% for preset in public_presets %}
                                                    <option value="{{ preset.pk }}">{{ preset.name }} (by {{ preset.owner.username }})</option>
                                                {% endfor %}
                                            </optgroup>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" id="loadPresetButton" class="btn btn-primary w-100" disabled>
                                        <i class="bi bi-download"></i> Load Preset
                                    </button>
                                    <a href="{% url 'maps:preset_list' %}" class="btn btn-sm btn-outline-secondary w-100 mt-1">
                                        <i class="bi bi-gear"></i> Manage Presets
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <i class="bi bi-info-circle"></i>
                        <strong>Tip:</strong> You don't have any presets yet.
                        <a href="{% url 'maps:preset_create' %}">Create a preset</a> to save your favorite generation settings for quick reuse.
                    </div>
                    {% endif %}

                    <form method="post" id="generateForm">
                        {% csrf_token %}
                        {% crispy form %}
                    </form>

                    <div id="previewSection" style="display: none;" class="mt-4">
                        <hr>
                        <h4>Map Preview</h4>
                        <div class="alert alert-info">
                            <strong>Preview Generated!</strong> Review the map below. You can accept and save it, or regenerate with different parameters.
                            <div class="mt-2">
                                <strong>Seed:</strong> <span id="previewSeed"></span>
                            </div>
                        </div>

                        <div id="previewMapContainer" style="overflow: auto; max-height: 600px; border: 2px solid #ddd; padding: 10px; background-color: #f5f5f5;">
                            <!-- Map preview will be rendered here -->
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-success" id="acceptButton">
                                <i class="bi bi-check-circle"></i> Accept and Save Map
                            </button>
                            <button type="button" class="btn btn-warning" id="regenerateButton">
                                <i class="bi bi-arrow-clockwise"></i> Regenerate
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelButton">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                        </div>
                    </div>

                    <hr>

                    <div class="mt-3">
                        <h5>Generation Algorithms</h5>
                        <ul class="list-unstyled">
                            <li><strong>Random:</strong> Simple random terrain distribution - good for outdoor areas</li>
                            <li><strong>BSP (Binary Space Partitioning):</strong> Creates rooms connected by corridors - ideal for buildings and dungeons</li>
                            <li><strong>Cellular Automata:</strong> Organic cave-like structures - perfect for natural caves and ruins</li>
                            <li><strong>Random Walk:</strong> Creates winding paths and tunnels - great for underground passages</li>
                            <li><strong>Maze:</strong> Generates complex mazes using recursive backtracking - challenging puzzle maps</li>
                        </ul>
                    </div>

                    <div class="mt-3">
                        <h5>Map Types</h5>
                        <ul class="list-unstyled">
                            <li><strong>Urban:</strong> Streets, sidewalks, and buildings for city environments</li>
                            <li><strong>Wilderness:</strong> Natural terrain with grass, forests, and water</li>
                            <li><strong>Corporate Facility:</strong> Indoor floors, walls, and rooms</li>
                            <li><strong>Underground/Sewer:</strong> Tunnels, caves, and underground passages</li>
                            <li><strong>Mixed Environment:</strong> Combination of multiple terrain types</li>
                        </ul>
                    </div>

                    <div class="alert alert-success mt-3">
                        <strong>Tip:</strong> Different algorithms work better with different map types:
                        <ul class="mb-0 mt-2">
                            <li>BSP + Corporate = Office buildings with rooms</li>
                            <li>Cellular Automata + Underground = Natural cave systems</li>
                            <li>Random Walk + Underground = Winding sewer tunnels</li>
                            <li>Maze + Corporate = Complex facility layouts</li>
                        </ul>
                    </div>

                    <a href="{% url 'maps:list' %}" class="btn btn-secondary mt-3">
                        <i class="bi bi-arrow-left"></i> Back to Maps
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const algorithmSelect = document.getElementById('id_algorithm');
    const generateForm = document.getElementById('generateForm');
    const previewSection = document.getElementById('previewSection');
    const previewMapContainer = document.getElementById('previewMapContainer');
    const previewSeed = document.getElementById('previewSeed');
    const acceptButton = document.getElementById('acceptButton');
    const regenerateButton = document.getElementById('regenerateButton');
    const cancelButton = document.getElementById('cancelButton');

    // Preset loading
    const presetSelector = document.getElementById('presetSelector');
    const loadPresetButton = document.getElementById('loadPresetButton');

    if (presetSelector && loadPresetButton) {
        // Enable button when preset is selected
        presetSelector.addEventListener('change', function() {
            loadPresetButton.disabled = !presetSelector.value;
        });

        // Load preset data when button is clicked
        loadPresetButton.addEventListener('click', function() {
            const presetId = presetSelector.value;
            if (!presetId) return;

            // Show loading state
            const originalText = loadPresetButton.innerHTML;
            loadPresetButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
            loadPresetButton.disabled = true;

            // Fetch preset data
            fetch(`/maps/presets/${presetId}/load/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate form fields with preset data
                    const preset = data.preset;

                    // Set basic fields
                    if (document.getElementById('id_name')) {
                        document.getElementById('id_name').value = preset.name + ' (Copy)';
                    }
                    if (document.getElementById('id_width')) {
                        document.getElementById('id_width').value = preset.width;
                    }
                    if (document.getElementById('id_height')) {
                        document.getElementById('id_height').value = preset.height;
                    }
                    if (document.getElementById('id_map_type')) {
                        document.getElementById('id_map_type').value = preset.map_type;
                    }
                    if (document.getElementById('id_algorithm')) {
                        document.getElementById('id_algorithm').value = preset.generation_algorithm;
                        // Trigger change event to update parameter visibility
                        algorithmSelect.dispatchEvent(new Event('change'));
                    }

                    // Show success message
                    alert('Preset loaded successfully! You can now modify the settings and generate the map.');
                } else {
                    alert('Error loading preset: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while loading the preset.');
            })
            .finally(() => {
                loadPresetButton.innerHTML = originalText;
                loadPresetButton.disabled = false;
            });
        });
    }

    function updateParameterVisibility() {
        // Hide all parameter sections
        document.getElementById('bsp-params').style.display = 'none';
        document.getElementById('cellular-params').style.display = 'none';
        document.getElementById('randomwalk-params').style.display = 'none';
        document.getElementById('maze-params').style.display = 'none';

        // Show the appropriate section based on selected algorithm
        const algorithm = algorithmSelect.value;
        if (algorithm === 'bsp') {
            document.getElementById('bsp-params').style.display = 'block';
        } else if (algorithm === 'cellular_automata') {
            document.getElementById('cellular-params').style.display = 'block';
        } else if (algorithm === 'random_walk') {
            document.getElementById('randomwalk-params').style.display = 'block';
        } else if (algorithm === 'maze') {
            document.getElementById('maze-params').style.display = 'block';
        }
    }

    // Update visibility on page load
    updateParameterVisibility();

    // Update visibility when algorithm selection changes
    algorithmSelect.addEventListener('change', updateParameterVisibility);

    // Intercept form submission to generate preview
    generateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        generatePreview();
    });

    function generatePreview() {
        // Show loading state
        const submitButton = generateForm.querySelector('input[type="submit"], button[type="submit"]');
        if (!submitButton) {
            console.error('Submit button not found');
            return;
        }
        const originalText = submitButton.value || submitButton.innerHTML;
        if (submitButton.tagName === 'INPUT') {
            submitButton.value = 'Generating Preview...';
        } else {
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating Preview...';
        }
        submitButton.disabled = true;

        // Get form data
        const formData = new FormData(generateForm);

        // Send AJAX request to preview endpoint
        fetch('{% url "maps:generate_preview" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display the preview
                displayPreview(data);
                // Scroll to preview
                previewSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error generating preview: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating the preview.');
        })
        .finally(() => {
            // Restore button state
            if (submitButton.tagName === 'INPUT') {
                submitButton.value = originalText;
            } else {
                submitButton.innerHTML = originalText;
            }
            submitButton.disabled = false;
        });
    }

    function displayPreview(data) {
        // Show preview section
        previewSection.style.display = 'block';

        // Display seed
        previewSeed.textContent = data.seed;

        // Render the map
        const tileSize = 20; // pixels per tile
        const mapHtml = renderMapGrid(data.tiles, data.width, data.height, tileSize);
        previewMapContainer.innerHTML = mapHtml;
    }

    function renderMapGrid(tiles, width, height, tileSize) {
        // Create a 2D array for quick lookup
        const grid = {};
        tiles.forEach(tile => {
            const key = `${tile.x},${tile.y}`;
            grid[key] = tile;
        });

        // Build HTML for the grid
        let html = '<div style="display: inline-block;">';
        for (let y = 0; y < height; y++) {
            html += '<div style="line-height: 0;">';
            for (let x = 0; x < width; x++) {
                const tile = grid[`${x},${y}`] || { color: '#FFFFFF' };
                html += `<div style="display: inline-block; width: ${tileSize}px; height: ${tileSize}px; background-color: ${tile.color}; border: 1px solid #ddd;" title="${tile.terrain_type || 'empty'} (${x},${y})"></div>`;
            }
            html += '</div>';
        }
        html += '</div>';
        return html;
    }

    // Handle accept button click
    acceptButton.addEventListener('click', function() {
        // Show loading state
        const originalAcceptText = acceptButton.innerHTML;
        acceptButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        acceptButton.disabled = true;

        // Create form data with confirm_save flag
        const formData = new FormData(generateForm);
        formData.append('confirm_save', 'true');

        // Send AJAX request to save the map
        fetch('{% url "maps:generate" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to the map detail page
                window.location.href = data.redirect_url;
            } else {
                alert('Error saving map: ' + JSON.stringify(data.errors || data.error));
                acceptButton.innerHTML = originalAcceptText;
                acceptButton.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the map.');
            acceptButton.innerHTML = originalAcceptText;
            acceptButton.disabled = false;
        });
    });

    // Handle regenerate button click
    regenerateButton.addEventListener('click', function() {
        // Hide preview and allow user to modify parameters
        previewSection.style.display = 'none';
        // Scroll back to form
        generateForm.scrollIntoView({ behavior: 'smooth' });
    });

    // Handle cancel button click
    cancelButton.addEventListener('click', function() {
        // Hide preview
        previewSection.style.display = 'none';
        // Optionally redirect back to maps list
        if (confirm('Are you sure you want to cancel? The preview will be discarded.')) {
            window.location.href = '{% url "maps:list" %}';
        } else {
            previewSection.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
